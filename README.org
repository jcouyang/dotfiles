#+TITLE: ä½¿ç”¨ dotfiles å’Œ stow ç®¡ç†ä½ çš„ dotfiles
#+AUTHOR: æ¬§é˜³ç»§è¶…
#+Date: <2015-10-29 Thu>

å¯èƒ½çœ‹æ ‡é¢˜ä½ è§‰å¾—æˆ‘ç–¯äº†ï¼Œä»€ä¹ˆå«ç”¨ dotfiles ç®¡ç†ä½ çš„ dotfilesã€‚

ç¬¬ä¸€ä¸ªå•è¯ [[http://dotfiles.github.io/][dotfiles]] æŒ‡å°† HOME ç›®å½•ä¸‹çš„ =.XXX= (å®ƒä»¬æ˜¯çœŸçš„å­—é¢æ„æ€dotfiles) æ–‡ä»¶åŒæ­¥åˆ° Github ä¸Šçš„æ–¹å¼ã€‚
é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­è£…çš„å¤§éƒ¨åˆ†å·¥å…·ï¼Œéƒ½ä¼šåœ¨ HOME ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥ =.= å¼€å¤´çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œæ”¾ç½®é…ç½®æˆ–è€…çŠ¶æ€ã€‚

å› æ­¤æˆ‘ä»¬å¸Œæœ›çš„æ˜¯ç”¨ github ç‰ˆæœ¬ç®¡ç†è¿™äº› *é…ç½®* ï¼Œè€Œä¸æ˜¯ *çŠ¶æ€* ã€‚

#+BEGIN_QUOTE
 ä¸‹é¢ä¾‹å­ä¸­çš„ dotfiles repo åœ¨[[https://github.com/jcouyang/dotfiles][è¿™é‡Œ]]
#+END_QUOTE

å¥½å§ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹åˆ°åº•å¦‚ä½•ç‰ˆæœ¬ç®¡ç†è¿™äº› â€œdotfilesâ€ã€‚

* ä½¿ç”¨ stow ç®¡ç† symlink
GNU stow æ˜¯ç®¡ç†ç¬¦å·é“¾æ¥ï¼ˆsymlinkï¼‰çš„ä¸€ä¸ªå°å…¬ä¸¾ã€‚åªéœ€è¦
#+BEGIN_SRC shell-script
brew install stow
#+END_SRC
 æˆ–è€…å¦‚æœä½ é mac æœºå™¨ï¼Œè¯·è®¿é—®[[http://www.gnu.org/software/stow/][å®˜ç½‘]]çœ‹çœ‹å¦‚ä½•å®‰è£…

å®‰è£…äº† stow ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ symlink ä¸€äº› dotfiles äº†ã€‚ä»¥ fish å’Œ omf ä¸ºä¾‹ï¼Œå®ƒä»¬æœ¬æ¥çš„ HOME ç›®å½•ä¸‹
çš„ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š
#+BEGIN_EXAMPLE -r -n
â‹Š> ~/dotfiles on master â¨¯ tree ~/.config                                             22:25:34
/Users/jcouyang/.config
â”œâ”€â”€ fish
â”‚Â Â  â”œâ”€â”€ config.fish
â”‚Â Â  â”œâ”€â”€ fish_history
â”‚Â Â  â””â”€â”€ fishd.a45e60d0d7e3
â””â”€â”€ omf
    â”œâ”€â”€ bundle
    â””â”€â”€ theme
#+END_EXAMPLE

** stow æ–‡ä»¶
 æ³¨æ„çœ‹æˆ‘ä»¬éœ€è¦ç‰ˆæœ¬ç®¡ç†æ–‡ä»¶åº”è¯¥æ˜¯ config.fish å’Œ omf ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œäºæ˜¯ï¼Œæˆ‘å°†è¿™äº›æ–‡ä»¶è€ƒåˆ°æˆ‘æ–°å»º
çš„ =~/dotfiles= ç›®å½•ä¸‹

#+BEGIN_EXAMPLE
mkdir ~/dotfiles/
cd ~/dotfiles
mkdir -p fish/.config/fish
mv ~/.config/fish/config.fish fish/.config/fish/
ls fish/.config/fish/
#+END_EXAMPLE

ç°åœ¨å¯ä»¥ä½¿ç”¨ stow åˆ›å»º symlink äº†ã€‚
#+BEGIN_SRC shell-script
stow fish
#+END_SRC

ç…ç… ç°åœ¨ =~/.config= å˜ä»€ä¹ˆæ ·äº†
#+BEGIN_EXAMPLE
â‹Š> ~/dotfiles on master â¨¯ tree ~/.config                                             22:33:55
/Users/jcouyang/.config
â”œâ”€â”€ fish
â”‚Â Â  â”œâ”€â”€ config.fish -> ../../dotfiles/fish/.config/fish/config.fish
â”‚Â Â  â”œâ”€â”€ fish_history
â”‚Â Â  â””â”€â”€ fishd.a45e60d0d7e3
#+END_EXAMPLE

=config.fish= è¢«é“¾åˆ°äº†æˆ‘åˆ›å»ºçš„ =dotfiles/fish= åº•ä¸‹åŒæ ·çš„ç›®å½•ä¸­ã€‚ é‡è¦çš„æ˜¯ä¸¤ä¸ªçŠ¶æ€æ–‡ä»¶ =fish_history= å’Œ
=fish.blahblah= ä»»ç„¶åœ¨ =~/.config/fish= ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³è¦ä»–ä»¬åˆ°æˆ‘ä»¬çš„ dotfiles ä¸­æ¥ã€‚

äºæ˜¯ï¼Œè¿™æ ·å…¶å®æ¯æ¬¡ä¿®æ”¹ =config.fish= éƒ½å®é™…ä¸Šæ˜¯åœ¨ä¿®æ”¹ =~/dotfiles=  ä¸‹çš„ =config.fish=

** stow ç›®å½•
å¦å¤–æˆ‘ä»¬åœ¨è¯•è¯•ç®¡ç† omf(oh-my-fish)ï¼Œä¼¼ä¹ omfä¸‹é¢æ²¡æœ‰ä»€ä¹ˆçŠ¶æ€ï¼Œbundle å’Œ theme éƒ½æ˜¯é…ç½®ï¼Œæ‰€ä»¥
ä¸å…¶ symlink æ–‡ä»¶ï¼Œä¸å¦‚ symlink æ•´ä¸ª omf ç›®å½•ã€‚åŒæ ·åœ¨ =~/dotfiles=  ç›®å½•ä¸‹è¿è¡Œ

#+BEGIN_EXAMPLE
mkdir -p ~/dotfiles/omf/.config
mv ~/.config/omf ~/dotfiles/omf/.config/omf
stow omf
#+END_EXAMPLE
 è¿™æ—¶å€™å†çœ‹çœ‹ =~/.config=
#+BEGIN_EXAMPLE
/Users/jcouyang/.config
â”œâ”€â”€ fish
â”‚Â Â  â”œâ”€â”€ config.fish -> ../../dotfiles/fish/.config/fish/config.fish
â”‚Â Â  â”œâ”€â”€ fish_history
â”‚Â Â  â””â”€â”€ fishd.a45e60d0d7e3
â””â”€â”€ omf -> ../dotfiles/omf/.config/omf
#+END_EXAMPLE
æˆ‘ä»¬æŠŠæ•´ä¸ª omf ç›®å½•éƒ½é“¾åˆ°äº† dotfile ç›®å½•ä¸‹

* push to github
ä¸‹é¢çœ‹å¦‚ä½•ç”¨ github æ¥ç®¡ç†è¿™äº› dotfiles

å¼ºçƒˆæ¨èå…ˆå®‰è£… [[http://hub.github.com/][hub]]
#+BEGIN_SRC shell-script
brew install hub
hub create dotfiles
git add .
git commit -m "my awesome dotfiles"
git push origin master
#+END_SRC

å°±è¿™ä¹ˆç®€å•ï¼Œä½ çš„é…ç½®æ–‡ä»¶å°±å®‰å…¨çš„æ”¾åˆ°äº† github ä¸Šï¼Œå¹¶ä¸”ä»¥åæ¯ä¸€æ¬¡æ”¹åŠ¨éƒ½å†ä¹Ÿä¸æ€•æ”¹æŒ‚äº†ã€‚

* submodule vs subtree
ä½†æ˜¯æˆ‘æœ‰äº›é…ç½®æ–‡ä»¶å…¶å®åœ¨å¦å¤–ä¸€ä¸ª repo ä¸Šï¼Œè¿™æ—¶å€™æˆ‘æ€ä¹ˆèƒ½è·Ÿè¿™ä¸ª =dotfiles= repo åˆåˆ°ä¸€èµ·å‘¢ï¼Ÿ

æ¯”å¦‚[[https://github.com/jcouyang/.emacs.d][æˆ‘çš„ emacs é…ç½®æ–‡ä»¶]]ï¼Œå…¶å®æ˜¯å•ç‹¬ç®¡ç†åœ¨å¦ä¸€ repo çš„ã€‚

è¿™æ—¶å€™ git ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ç§æ–¹å¼æ¥ç®¡ç† submodule å’Œ subtreeã€‚ æˆ‘ç”¨çš„æ˜¯åä¸€ç§ï¼Œè‡³äº submodule
ä¸ºä»€ä¹ˆä¸é€‚ç”¨ï¼Œç½‘ä¸Šæœ‰[[http://blogs.atlassian.com/2013/05/alternatives-to-git-submodule-git-subtree/][å¤§é‡æ–‡ç« ]]è§£é‡Šï¼Œæˆ‘å°±æ‡’å¾—ç¿»è¯‘äº†ã€‚

#+BEGIN_SRC shell-script
â‹Š> ~/dotfiles on master â¨¯ git subtree add --prefix emacs/.emacs.d git@github.com:jcouyang/.emacs.d.git master --squash
#+END_SRC
è¿™è¡Œ subtree å‘½ä»¤æŠŠæˆ‘çš„ emacs é…ç½®ä»æˆ‘çš„ repo ä¸‹ä¸‹æ¥ä½œä¸º subtreeï¼Œå¹¶ squash(åˆæˆä¸€ä¸ª) commits

 è¿™æ—¶æˆ‘çš„ gitæ ‘æ˜¯è¿™æ ·çš„
#+BEGIN_EXAMPLE 
\* commit b33c46bfebe4a28849aa967222555a4676fdb9f4 (HEAD -> master)
|\  Merge: 1b240f8 e6dacdc
| | Author: Jichao Ouyang <oyanglulu@gmail.com>
| | Date:   Thu Oct 29 21:33:06 2015 +0800
| |
| |     Merge commit 'e6dacdcd1f85cdcb3b5fa488edb7b8f31c297b3f' as 'emacs/.emacs.d'
| |
| * commit e6dacdcd1f85cdcb3b5fa488edb7b8f31c297b3f
#+END_EXAMPLE

å¯ä»¥çœ‹è§æŠŠ æˆ‘çš„ emacs repo merge äº†è¿›æ¥ï¼Œè¿™æ ·å°±è·Ÿåœ¨ =dotfiles= repo çš„ä»£ç ä¸€æ ·ï¼Œè¯¥ commit çš„ commit è¯¥
 push çš„ pushã€‚

ä¸‹é¢çœ‹å¦‚ä½• push å›æˆ‘çš„ emacs repoã€‚

æ¯”å¦‚æˆ‘ç°åœ¨å¯¹ subtree emacs åšäº†æ”¹åŠ¨å¹¶ commit äº†ã€‚ç„¶å

#+BEGIN_EXAMPLE
git remote add emacs git@github.com:jcouyang/.emacs.d.git
git subtree push --prefix emacs/.emacs.d emacs master
#+END_EXAMPLE
1. å…ˆæŠŠ emacs çš„ repo åŠ åˆ°æˆ‘çš„ remote é‡Œï¼Œç»™ä¸ªåå­— emacs
2. ç”¨ subtree push ç›´æ¥ push åˆ° remote emacsï¼Œbranch master


* ãŠ™ Sensitive dotfiles
æœ‰äº› dotfiles  ä¸­å¯èƒ½æ¶‰åŠä¸€äº› token æˆ–è€…å¯†ç ï¼Œå¦‚æœæŠŠä»–ä»¬ push åˆ° public çš„ github ä¸Šï¼Œ +æœ‰å¯èƒ½+ è‚¯å®šä¼šå¯¹ä½ ä¸ªäººæˆ–è€…å…¬å¸é€ æˆå·¨å¤§çš„æŸå¤±ï¼ˆæœ€è¿‘å…¬å¸å°±å¼€å§‹æ‰«æä¸ªäºº github è´¦æˆ·äº†ğŸ™€ å¥½ç´§å¼ ï¼‰ã€‚äºæ˜¯æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æ•æ„Ÿçš„ dotfiles åšåŠ å¯†ã€‚

æ¯”å¦‚ =~/.config/hub= é‡Œé¢ï¼Œæœ‰æˆ‘å’Œå…¬å¸çš„ github çš„ tokenï¼Œæˆ‘å¯ä¸åƒè¿™ç©æ„è¢«å¼„åˆ° github ä¸Šã€‚

ç›®å‰æœ€å¹¿æ³›ä½¿ç”¨çš„åŠ å¯†æ‰‹æ®µæ˜¯ Gnupgï¼Œç®€ç§° gpgï¼Œä¸€æ ·ä½¿ç”¨ brew è£…å°±å¥½äº†
#+BEGIN_SRC sh
brew install gnupg
#+END_SRC

å®‰è£…å®Œä¹‹åéœ€è¦ç”Ÿæˆä¸€ä¸ª keypair
#+BEGIN_SRC sh
gpg --gen-key
#+END_SRC

 è¾“å…¥åå­—ï¼Œé‚®ç®±ï¼Œå¯†ç ä¹‹åï¼Œå°± ok äº†

 ç„¶åå‘¢ï¼Œæˆ‘å¹¶ä¸å¸Œæœ›æ‰‹åŠ¨çš„æ¯æ¬¡åŠ å¯†å®Œå†push åˆ°æˆ‘çš„ç§æœ‰ git ä¸Šï¼ˆå¯¹ï¼Œå³ä½¿æ˜¯ç§æœ‰ gitï¼Œå®‰å…¨è€ƒè™‘æˆ‘è¿˜æ˜¯éœ€è¦åŠ å¯†ï¼Œç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨ï¼Œå°±æ˜¯è¿™ä¹ˆä»»æ€§ï¼‰ã€‚

é‚£ä¹ˆåˆ°åº•å»å“ªå¼„ä¸€ä¸ªç§æœ‰ git å‘¢ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œdropbox å°±å¯ä»¥ï¼Œç„¶åç°åœ¨çš„é—®é¢˜æ˜¯å¦‚ä½•åœ¨ push çš„æ—¶å€™è‡ªåŠ¨çš„ gpg åŠ å¯†ã€‚

ç°åœ¨ git remote crypt  å¤§æ³•å°±è¯¥ç™»åœºäº†ï¼Œåˆ°è¿™é‡Œ https://github.com/joeyh/git-remote-gcrypt  æŠŠ repo ä¸‹ä¸‹æ¥æ‰§è¡Œ =./install.sh=, ä¹‹åå°±åº”è¯¥æœ‰ =git-remote-gcrypt= è¿™æ ·ä¸€ä¸ªå‘½ä»¤ï¼Œå…ˆåˆ«è·‘

å…³é”®åœ¨äºè§ remote çš„æ—¶å€™ã€‚å½“æˆ‘åœ¨ home ç›®å½•å»ºäº†ä¸€ä¸ª =dotfiles-private= çš„æ–‡ä»¶å¤¹ï¼Œstow å®Œå„ç§æ•æ„Ÿ dotfiles ä¹‹å
#+BEGIN_SRC sh
git init
git add .
git commit -m "some private dotfiles"
git remote add dropbox gcrypt::rsync:///Users/jcouyang/Dropbox/dotfiles-private.git
git push
#+END_SRC

ä½ ä¼šè¢«é—®åˆ°åˆšæ‰åˆ›å»º gpg keypair æ—¶è¾“å…¥çš„å¯†ç ï¼Œç„¶å...

çœ‹ï¼Œä¸¤å¨ gpg åŠ å¯†è¿‡çš„æ–‡ä»¶
[[https://www.evernote.com/l/ABezPtVV1YxHFrYpAsVE_G_oc5-O0bmzqYMB/image.png]]

*LLAP ğŸ––*
